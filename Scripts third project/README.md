                                           Описание проекта. Система управления персоналом «Всё записано»
Вы работаете в растущей IT-компании Dream Big. Специализация компании — разработка программного обеспечения на заказ. Десятки сотрудников каждый день без устали трудятся над самыми разнообразными проектами: 
от скромных приложений до грандиозных платформ. Вы попивали кофе во время перерыва, когда ворвался взъерошенный тимлид Арсений с новой горящей задачей — нужно автоматизировать некоторые процессы в 
Dream Big для внутренней системы управления персоналом под кодовым названием «Всё записано». В компании есть база данных PostgreSQL с детализированной информацией о сотрудниках, проектах и логах времени. 
Сейчас структуре БД и механизмам запросов не хватает гибкости и производительности. Кроме того, политика безопасности проекта гласит: все запросы выполняются строго через функции и процедуры, 
сырые запросы к таблицам — запрещены. Ваша задача — создать ряд хранимых процедур и функций, которые оптимизируют и автоматизируют процессы извлечения, анализа и изменения данных. 
Арсений предполагает, что это позволит менеджерам по персоналу и бухгалтерии Dream Big быстро получать отчёты, анализировать рабочие часы и корректировать данные в режиме реального времени.

Задание 1
В Dream Big ежемесячно оценивают производительность сотрудников. В результате бывает, кому-то повышают, а изредка понижают почасовую ставку. 
Напишите хранимую процедуру update_employees_rate, которая обновляет почасовую ставку сотрудников на определённый процент. При понижении ставка не может быть ниже минимальной — 500 рублей в час. 
Если по расчётам выходит меньше, устанавливают минимальную ставку.
На вход процедура принимает строку в формате json.

Задание 2
С ростом доходов компании и учётом ежегодной инфляции Dream Big индексирует зарплату всем сотрудникам.
Напишите хранимую процедуру indexing_salary, которая повышает зарплаты всех сотрудников на определённый процент. 
Процедура принимает один целочисленный параметр — процент индексации p. Сотрудникам, которые получают зарплату по ставке ниже средней относительно всех сотрудников до индексации, 
начисляют дополнительные 2% (p + 2). Ставка остальных сотрудников увеличивается на p%.
Зарплата хранится в БД в типе данных integer, поэтому если в результате повышения зарплаты образуется дробное число, его нужно округлить до целого.

Задание 3
Завершая проект, нужно сделать два действия в системе учёта:
Изменить значение поля is_active в записи проекта на false — чтобы рабочее время по этому проекту больше не учитывалось.
Посчитать бонус, если он есть — то есть распределить неизрасходованное время между всеми членами команды проекта. Неизрасходованное время — это разница между временем, 
которое выделили на проект (estimated_time), и фактически потраченным. Если поле estimated_time не задано, бонусные часы не распределятся. Если отработанных часов нет — расчитывать бонус не нужно.
Разберёмся с бонусом. 
Если в момент закрытия проекта estimated_time:
не NULL,
больше суммы всех отработанных над проектом часов,
всем членам команды проекта начисляют бонусные часы.
Размер бонуса считают так: 75% от сэкономленных часов делят на количество участников проекта, но не более 16 бонусных часов на сотрудника. Дробные значения округляют в меньшую сторону 
(например, 3.7 часа округляют до 3). Рабочие часы заносят в логи с текущей датой. 
Например, если на проект запланировали 100 часов, а сделали его за 30 — 3/4 от сэкономленных 70 часов распределят бонусом между участниками проекта.
Создайте пользовательскую процедуру завершения проекта close_project. Если проект уже закрыт, процедура должна вернуть ошибку без начисления бонусных часов.

Задание 4
Напишите процедуру log_work для внесения отработанных сотрудниками часов. Процедура добавляет новые записи о работе сотрудников над проектами.
Процедура принимает id сотрудника, id проекта, дату и отработанные часы и вносит данные в таблицу logs. 
Если проект завершён, добавить логи нельзя — процедура должна вернуть ошибку Project closed. Количество залогированных часов может быть в этом диапазоне: от 1 до 24 включительно — 
- нельзя внести менее 1 часа или больше 24. Если количество часов выходит за эти пределы, необходимо вывести предупреждение о недопустимых данных и остановить выполнение процедуры.
Запись помечается флагом required_review, если:
залогированно более 16 часов за один день — Dream Big заботится о здоровье сотрудников;
запись внесена будущим числом;
запись внесена более ранним числом, чем на неделю назад от текущего дня — например, если сегодня 10.04.2023, все записи старше 3.04.2023 получат флажок.

Задание 5
Чтобы бухгалтерия корректно начисляла зарплату, нужно хранить историю изменения почасовой ставки сотрудников. Создайте отдельную таблицу employee_rate_history с такими столбцами:
id — id записи,
employee_id — id сотрудника,
rate — почасовая ставка сотрудника,
from_date — дата назначения новой ставки.
Внесите в таблицу текущие данные всех сотрудников. В качестве from_date используйте дату основания компании: '2020-12-26'.
Напишите триггерную функцию save_employee_rate_history и триггер change_employee_rate. При добавлении сотрудника в таблицу employees и изменении ставки сотрудника триггер автоматически вносит запись в
таблицу employee_rate_history из трёх полей: id сотрудника, его ставки и текущей даты.

Задание 6
После завершения каждого проекта Dream Big проводит корпоративную вечеринку, чтобы отпраздновать очередной успех и поощрить сотрудников. Тех, кто посвятил проекту больше всего часов,
награждают премией «Айтиголик» — они получают почётные грамоты и ценные подарки от заказчика. Чтобы вычислить айтиголиков проекта, напишите функцию best_project_workers.
Функция принимает id проекта и возвращает таблицу с именами трёх сотрудников, которые залогировали максимальное количество часов в этом проекте. Результирующая таблица состоит из двух полей:
имени сотрудника и количества часов, отработанных на проекте.

Задание 7
К вам заглянул утомлённый главный бухгалтер Марк Захарович с лёгкой синевой под глазами и попросил как-то автоматизировать расчёт зарплаты, пока бухгалтерия не испустила дух.
Напишите для бухгалтерии функцию calculate_month_salary для расчёта зарплаты за месяц.
Функция принимает в качестве параметров даты начала и конца месяца и возвращает результат в виде таблицы с четырьмя полями: id (сотрудника), employee (имя сотрудника), worked_hours и salary.
Процедура суммирует все залогированные часы за определённый месяц и умножает на актуальную почасовую ставку сотрудника. Исключения — записи с флажками required_review и is_paid.
Если суммарно по всем проектам сотрудник отработал более 160 часов в месяц, все часы свыше 160 оплатят с коэффициентом 1.25.
